{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* --- DASHBOARD LAYOUT --- */
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  .kpi-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #eef3fb;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    text-align: center;
  }
  .kpi-num {
    font-size: 32px;
    font-weight: 800;
    color: #0f66d4;
    margin-top: 5px;
  }
  .kpi-label {
    color: #6f7a85;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
  }

  /* --- CHART LAYOUT --- */
  .charts-row {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 20px;
    margin-bottom: 30px;
  }
  .chart-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    border: 1px solid #eef3fb;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    min-width: 0;
  }
  .chart-container {
    position: relative;
    height: 300px;
    width: 100%;
  }
  @media (max-width: 768px) {
    .charts-row { grid-template-columns: 1fr; }
  }
</style>

<div class="page" style="max-width:1200px; margin:24px auto;">

  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
    <div>
      <h1 style="margin:0; font-size:28px;">Executive Overview</h1>
      <p style="color:#666; margin-top:4px;">Global system health monitoring (God Mode)</p>
    </div>
    <div style="background:#fff3cd; color:#856404; padding:8px 16px; border-radius:20px; font-weight:bold; font-size:13px; border:1px solid #ffeeba;">
      ðŸ‘‘ Super Admin Access
    </div>
  </div>

  <div class="dashboard-grid">
    <div class="kpi-card">
      <div class="kpi-label">Total Tickets</div>
      <div class="kpi-num">{{ stats.total }}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Open Issues</div>
      <div class="kpi-num" style="color:#f97316">{{ stats.open }}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">In Progress</div>
      <div class="kpi-num" style="color:#7c3aed">{{ stats.in_progress }}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Resolved</div>
      <div class="kpi-num" style="color:#0ea25b">{{ stats.resolved }}</div>
    </div>
  </div>

  <div class="charts-row">
    <div class="chart-card">
      <h3 style="margin-top:0;">Department Load</h3>
      <div class="chart-container">
        <canvas id="categoryChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <h3 style="margin-top:0;">Ticket Status Overview</h3>
      <div class="chart-container">
        <canvas id="statusChart"></canvas>
      </div>
    </div>
  </div>

  <div class="chart-card">
    <h3 style="margin-top:0; margin-bottom:15px;">Recent Global Activity</h3>
    <table class="table" style="width:100%; border-collapse:collapse;">
      <thead style="background:#f8fafc; text-align:left;">
        <tr>
          <th style="padding:12px;">ID</th>
          <th style="padding:12px;">Subject</th>
          <th style="padding:12px;">Department</th>
          <th style="padding:12px;">Priority</th>
          <th style="padding:12px;">Status</th>
          <th style="padding:12px;">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for t in tickets[:10] %}
        <tr style="border-bottom:1px solid #eee;">
          <td style="padding:12px;">#{{ t.id }}</td>
          <td style="padding:12px; font-weight:600;">{{ t.subject }}</td>
          <td style="padding:12px;">
            <span style="padding:4px 8px; background:#eef3fb; border-radius:4px; font-size:12px; text-transform:capitalize;">
              {{ t.category }}
            </span>
          </td>
          <td style="padding:12px;">
            <span class="chip {{ 'chip-high' if t.priority=='high' else ('chip-medium' if t.priority=='medium' else 'chip-low') }}">
              {{ t.priority|capitalize }}
            </span>
          </td>
          <td style="padding:12px;">{{ t.status|capitalize }}</td>
          <td style="padding:12px;">
            <a href="{{ url_for('ticket_detail', ticket_id=t.id) }}" style="color:#0f66d4; text-decoration:none; font-weight:bold;">View</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("Initializing Dashboard Charts...");

    // Safe Data Injection
    // FIXED: Changed dashboard_stats to stats here as well
    const stats = {
      software: {{ stats.software | default(0) }},
      hardware: {{ stats.hardware | default(0) }},
      network: {{ stats.network | default(0) }},
      database: {{ stats.database | default(0) }},
      open: {{ stats.open | default(0) }},
      in_progress: {{ stats.in_progress | default(0) }},
      resolved: {{ stats.resolved | default(0) }}
    };

  // 1. Department Pie Chart
  const ctxCat = document.getElementById('categoryChart');
  if (ctxCat) {
    new Chart(ctxCat.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: ['Software', 'Hardware', 'Network', 'Database'],
        datasets: [{
          data: [stats.software, stats.hardware, stats.network, stats.database],
          backgroundColor: ['#3b82f6', '#14b8a6', '#f59e0b', '#8b5cf6'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false, 
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }

  // 2. Status Bar Chart
  const ctxStat = document.getElementById('statusChart');
  if (ctxStat) {
    new Chart(ctxStat.getContext('2d'), {
      type: 'bar',
      data: {
        labels: ['Open', 'In Progress', 'Resolved'],
        datasets: [{
          label: 'Tickets',
          data: [stats.open, stats.in_progress, stats.resolved],
          backgroundColor: ['#f97316', '#7c3aed', '#0ea25b'],
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } }
      }
    });
  }
  });
</script>

{% endblock %}